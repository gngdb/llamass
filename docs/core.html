---

title: core


keywords: fastai
sidebar: home_sidebar

summary: "Unpack and load the [AMASS][] dataset for training with a PyTorch iterator."
description: "Unpack and load the [AMASS][] dataset for training with a PyTorch iterator."
nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Unpack-Tar-Files">Unpack Tar Files<a class="anchor-link" href="#Unpack-Tar-Files"> </a></h1><blockquote><p>Console script to unpack all tar files found in a specified directory and put them in another directory, then create a symlink to be able to find the unpacked data later</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Checksum-Directories">Checksum Directories<a class="anchor-link" href="#Checksum-Directories"> </a></h2><blockquote><p>Checksum directories to only unpack tar files when target directory either doesn't exist or has been incorrectly unpacked.</p>
</blockquote>
<p>It would probably be sufficient to check if the target directory exists, but this is more thorough.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5_update_from_file" class="doc_header"><code>md5_update_from_file</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5_update_from_file</code>(<strong><code>filename</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>], <strong><code>hash</code></strong>:<code>HASH</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5_file" class="doc_header"><code>md5_file</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L23" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5_file</code>(<strong><code>filename</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5_update_from_dir" class="doc_header"><code>md5_update_from_dir</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L27" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5_update_from_dir</code>(<strong><code>directory</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>], <strong><code>hash</code></strong>:<code>HASH</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5_dir" class="doc_header"><code>md5_dir</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L38" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5_dir</code>(<strong><code>directory</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parallel-Unpacking-with-Joblib">Parallel Unpacking with Joblib<a class="anchor-link" href="#Parallel-Unpacking-with-Joblib"> </a></h2><blockquote><p>Unpacks tar files in multiple jobs to speed up unpacking the dataset.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ProgressParallel" class="doc_header"><code>class</code> <code>ProgressParallel</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L92" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ProgressParallel</code>(<strong><code>n_jobs</code></strong>=<em><code>None</code></em>, <strong><code>backend</code></strong>=<em><code>None</code></em>, <strong><code>verbose</code></strong>=<em><code>0</code></em>, <strong><code>timeout</code></strong>=<em><code>None</code></em>, <strong><code>pre_dispatch</code></strong>=<em>`'2 </em> n_jobs'<code>*, **</code>batch_size<code>**=*</code>'auto'<code>*, **</code>temp_folder<code>**=*</code>None<code>*, **</code>max_nbytes<code>**=*</code>'1M'<code>*, **</code>mmap_mode<code>**=*</code>'r'<code>*, **</code>prefer<code>**=*</code>None<code>*, **</code>require<code>**=*</code>None<code>*) ::</code>Parallel`</p>
</blockquote>
<p>Helper class for readable parallel mapping.</p>
<p>Read more in the :ref:<code>User Guide &lt;parallel&gt;</code>.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>n_jobs: int, default: None
    The maximum number of concurrently running jobs, such as the number
    of Python worker processes when backend="multiprocessing"
    or the size of the thread-pool when backend="threading".
    If -1 all CPUs are used. If 1 is given, no parallel computing code
    is used at all, which is useful for debugging. For n_jobs below -1,
    (n_cpus + 1 + n_jobs) are used. Thus for n_jobs = -2, all
    CPUs but one are used.
    None is a marker for 'unset' that will be interpreted as n_jobs=1
    (sequential execution) unless the call is performed under a
    parallel_backend context manager that sets another value for
    n_jobs.
backend: str, ParallelBackendBase instance or None, default: 'loky'
    Specify the parallelization backend implementation.
    Supported backends are:</p>

<pre><code>- "loky" used by default, can induce some
  communication and memory overhead when exchanging input and
  output data with the worker Python processes.
- "multiprocessing" previous process-based backend based on
  `multiprocessing.Pool`. Less robust than `loky`.
- "threading" is a very low-overhead backend but it suffers
  from the Python Global Interpreter Lock if the called function
  relies a lot on Python objects. "threading" is mostly useful
  when the execution bottleneck is a compiled extension that
  explicitly releases the GIL (for instance a Cython loop wrapped
  in a "with nogil" block or an expensive call to a library such
  as NumPy).
- finally, you can register backends by calling
  register_parallel_backend. This will allow you to implement
  a backend of your liking.

It is not recommended to hard-code the backend name in a call to
Parallel in a library. Instead it is recommended to set soft hints
(prefer) or hard constraints (require) so as to make it possible
for library users to change the backend from the outside using the
parallel_backend context manager.
</code></pre>
<p>prefer: str in {'processes', 'threads'} or None, default: None
    Soft hint to choose the default backend if no specific backend
    was selected with the parallel_backend context manager. The
    default process-based backend is 'loky' and the default
    thread-based backend is 'threading'. Ignored if the <code>backend</code>
    parameter is specified.
require: 'sharedmem' or None, default None
    Hard constraint to select the backend. If set to 'sharedmem',
    the selected backend will be single-host and thread-based even
    if the user asked for a non-thread based backend with
    parallel_backend.
verbose: int, optional
    The verbosity level: if non zero, progress messages are
    printed. Above 50, the output is sent to stdout.
    The frequency of the messages increases with the verbosity level.
    If it more than 10, all iterations are reported.
timeout: float, optional
    Timeout limit for each task to complete.  If any task takes longer
    a TimeOutError will be raised. Only applied when n_jobs != 1
pre_dispatch: {'all', integer, or expression, as in '3<em>n_jobs'}
    The number of batches (of tasks) to be pre-dispatched.
    Default is '2</em>n_jobs'. When batch_size="auto" this is reasonable
    default and the workers should never starve.
batch_size: int or 'auto', default: 'auto'
    The number of atomic tasks to dispatch at once to each
    worker. When individual evaluations are very fast, dispatching
    calls to workers can be slower than sequential computation because
    of the overhead. Batching fast computations together can mitigate
    this.
    The <code>'auto'</code> strategy keeps track of the time it takes for a batch
    to complete, and dynamically adjusts the batch size to keep the time
    on the order of half a second, using a heuristic. The initial batch
    size is 1.
    <code>batch_size="auto"</code> with <code>backend="threading"</code> will dispatch
    batches of a single task at a time as the threading backend has
    very little overhead and using larger batch size has not proved to
    bring any gain in that case.
temp_folder: str, optional
    Folder to be used by the pool for memmapping large arrays
    for sharing memory with worker processes. If None, this will try in
    order:</p>

<pre><code>- a folder pointed by the JOBLIB_TEMP_FOLDER environment
  variable,
- /dev/shm if the folder exists and is writable: this is a
  RAM disk filesystem available by default on modern Linux
  distributions,
- the default system temporary folder that can be
  overridden with TMP, TMPDIR or TEMP environment
  variables, typically /tmp under Unix operating systems.

Only active when backend="loky" or "multiprocessing".
</code></pre>
<p>max_nbytes int, str, or None, optional, 1M by default
    Threshold on the size of arrays passed to the workers that
    triggers automated memory mapping in temp_folder. Can be an int
    in Bytes, or a human-readable string, e.g., '1M' for 1 megabyte.
    Use None to disable memmapping of large arrays.
    Only active when backend="loky" or "multiprocessing".
mmap_mode: {None, 'r+', 'r', 'w+', 'c'}
    Memmapping mode for numpy arrays passed to workers.
    See 'max_nbytes' parameter documentation for more details.</p>
<h2 id="Notes">Notes<a class="anchor-link" href="#Notes"> </a></h2><p>This object uses workers to compute in parallel the application of a
function to many different arguments. The main functionality it brings
in addition to using the raw multiprocessing or concurrent.futures API
are (see examples for details):</p>
<ul>
<li><p>More readable code, in particular since it avoids
constructing list of arguments.</p>
</li>
<li><p>Easier debugging:</p>
<ul>
<li>informative tracebacks even when the error happens on
the client side</li>
<li>using 'n_jobs=1' enables to turn off parallel computing
for debugging without changing the codepath</li>
<li>early capture of pickling errors</li>
</ul>
</li>
<li><p>An optional progress meter.</p>
</li>
<li><p>Interruption of multiprocesses jobs with 'Ctrl-C'</p>
</li>
<li><p>Flexible pickling control for the communication to and from
the worker processes.</p>
</li>
<li><p>Ability to use shared memory efficiently with worker
processes for large numpy-based datastructures.</p>
</li>
</ul>
<h2 id="Examples">Examples<a class="anchor-link" href="#Examples"> </a></h2><p>A simple example:</p>
<blockquote><blockquote><blockquote><p>from math import sqrt
from joblib import Parallel, delayed
Parallel(n_jobs=1)(delayed(sqrt)(i**2) for i in range(10))
[0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0]</p>
</blockquote>
</blockquote>
</blockquote>
<p>Reshaping the output when the function has several return
values:</p>
<blockquote><blockquote><blockquote><p>from math import modf
from joblib import Parallel, delayed
r = Parallel(n_jobs=1)(delayed(modf)(i/2.) for i in range(10))
res, i = zip(*r)
res
(0.0, 0.5, 0.0, 0.5, 0.0, 0.5, 0.0, 0.5, 0.0, 0.5)
i
(0.0, 0.0, 1.0, 1.0, 2.0, 2.0, 3.0, 3.0, 4.0, 4.0)</p>
</blockquote>
</blockquote>
</blockquote>
<p>The progress meter: the higher the value of <code>verbose</code>, the more
messages:</p>
<blockquote><blockquote><blockquote><p>from time import sleep
from joblib import Parallel, delayed
r = Parallel(n<em>jobs=2, verbose=10)(delayed(sleep)(.2) for </em> in range(10)) #doctest: +SKIP
[Parallel(n_jobs=2)]: Done   1 tasks      | elapsed:    0.6s
[Parallel(n_jobs=2)]: Done   4 tasks      | elapsed:    0.8s
[Parallel(n_jobs=2)]: Done  10 out of  10 | elapsed:    1.4s finished</p>
</blockquote>
</blockquote>
</blockquote>
<p>Traceback example, note how the line of the error is indicated
as well as the values of the parameter passed to the function that
triggered the exception, even though the traceback happens in the
child process:</p>
<blockquote><blockquote><blockquote><p>from heapq import nlargest
from joblib import Parallel, delayed
Parallel(n_jobs=2)(delayed(nlargest)(2, n) for n in (range(4), 'abcde', 3)) #doctest: +SKIP</p>
<h1 id="...">...<a class="anchor-link" href="#..."> </a></h1><hr>
<h2 id="Sub-process-traceback:">Sub-process traceback:<a class="anchor-link" href="#Sub-process-traceback:"> </a></h2><p>TypeError                                          Mon Nov 12 11:37:46 2012
PID: 12934                                    Python 2.7.3: /usr/bin/python
...........................................................................
/usr/lib/python2.7/heapq.pyc in nlargest(n=2, iterable=3, key=None)
    419         if n &gt;= size:
    420             return sorted(iterable, key=key, reverse=True)[:n]
    421
    422     # When key is none, use simpler decoration
    423     if key is None:
--&gt; 424         it = izip(iterable, count(0,-1))                    # decorate
    425         result = _nlargest(n, it)
    426         return map(itemgetter(0), result)                   # undecorate
    427
    428     # General case, slowest method
 TypeError: izip argument #1 must support iteration</p>
<hr>
</blockquote>
</blockquote>
</blockquote>
<p>Using pre_dispatch in a producer/consumer situation, where the
data is generated on the fly. Note how the producer is first
called 3 times before the parallel loop is initiated, and then
called to generate new data on the fly:</p>
<blockquote><blockquote><blockquote><p>from math import sqrt
from joblib import Parallel, delayed
def producer():
...     for i in range(6):
...         print('Produced %s' % i)
...         yield i
out = Parallel(n_jobs=2, verbose=100, pre_dispatch='1.5*n_jobs')(
...                delayed(sqrt)(i) for i in producer()) #doctest: +SKIP
Produced 0
Produced 1
Produced 2
[Parallel(n_jobs=2)]: Done 1 jobs     | elapsed:  0.0s
Produced 3
[Parallel(n_jobs=2)]: Done 2 jobs     | elapsed:  0.0s
Produced 4
[Parallel(n_jobs=2)]: Done 3 jobs     | elapsed:  0.0s
Produced 5
[Parallel(n_jobs=2)]: Done 4 jobs     | elapsed:  0.0s
[Parallel(n_jobs=2)]: Done 6 out of 6 | elapsed:  0.0s remaining: 0.0s
[Parallel(n_jobs=2)]: Done 6 out of 6 | elapsed:  0.0s finished</p>
</blockquote>
</blockquote>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="lazy_unpack" class="doc_header"><code>lazy_unpack</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L102" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>lazy_unpack</code>(<strong><code>tarpath</code></strong>, <strong><code>outdir</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="unpack_body_models" class="doc_header"><code>unpack_body_models</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L125" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>unpack_body_models</code>(<strong><code>tardir</code></strong>, <strong><code>outdir</code></strong>, <strong><code>n_jobs</code></strong>=<em><code>1</code></em>, <strong><code>verify</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="fast_amass_unpack" class="doc_header"><code>fast_amass_unpack</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L138" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fast_amass_unpack</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test unpacking the sample data always yields the same result:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="c1"># https://stackoverflow.com/a/3431838/6937913</span>
<span class="k">def</span> <span class="nf">md5</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">hash_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">hash_md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hash_md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="n">md5sums</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;amass_sample.npz&quot;</span><span class="p">:</span> <span class="s2">&quot;d0b546b3619c8579ade39e3a8ccdc4e2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmpl_sample.npz&quot;</span><span class="p">:</span> <span class="s2">&quot;576bb76b2a6328dc5c276c4150c466f0&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">):</span>
        <span class="n">npz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="s2">&quot;npz&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
        <span class="n">npz_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">npz_files</span><span class="p">]</span>
    <span class="n">_md5sums</span> <span class="o">=</span> <span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fpath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">md5</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">}</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">md5sums</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">md5sums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">_md5sums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmps93l76ly
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Testing that <code>verify=True</code> works as expected. Can redefine <a href="/llamass/core.html#hashes"><code>hashes</code></a> here for testing without breaking the exported library because this cell doesn't get exported by <code>nbdev</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="n">hashes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sample.tar.bz2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;unpacks_to&#39;</span><span class="p">:</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="s1">&#39;b5a86fe22ed2799d79101a532eb0ff27&#39;</span><span class="p">}}</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">unpacking_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">skip_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">assert</span> <span class="n">unpacking_time</span> <span class="o">&gt;</span> <span class="n">skip_time</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmp5unr3c6d
sample_data/sample.tar.bz2 extracting to /tmp/tmp5unr3c6d
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Loading-Functions">Loading Functions<a class="anchor-link" href="#Loading-Functions"> </a></h1><blockquote><p>Load the pose data directly from the <code>npz</code> files after unpacking.</p>
</blockquote>
<p>Based on the <a href="https://github.com/nghorbani/amass/tree/master/notebooks">AMASS tutorial notebooks</a>, I would like to iterate over the dataset using a PyTorch Dataloader.</p>
<p>Steps to load:1. Enumerate the paths to all the <code>npz</code> files2. Inspect files for frame data</p>
<ol>
<li>Map from a global dataset index to indexes for each frame clip</li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looking at the sample data:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">):</span>
        <span class="n">npz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="s2">&quot;npz&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
        <span class="n">npz_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">npz_files</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">:</span>
        <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">cdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmpephft3on
/tmp/tmpephft3on/sample/subdir/amass_sample.npz
   [&#39;poses&#39;, &#39;gender&#39;, &#39;mocap_framerate&#39;, &#39;betas&#39;, &#39;marker_data&#39;, &#39;dmpls&#39;, &#39;marker_labels&#39;, &#39;trans&#39;]
   [(&#39;poses&#39;, (601, 156)), (&#39;gender&#39;, ()), (&#39;mocap_framerate&#39;, ()), (&#39;betas&#39;, (16,)), (&#39;marker_data&#39;, (601, 85, 3)), (&#39;dmpls&#39;, (601, 8)), (&#39;marker_labels&#39;, (85,)), (&#39;trans&#39;, (601, 3))]
/tmp/tmpephft3on/sample/subdir/dmpl_sample.npz
   [&#39;poses&#39;, &#39;gender&#39;, &#39;mocap_framerate&#39;, &#39;betas&#39;, &#39;marker_data&#39;, &#39;dmpls&#39;, &#39;marker_labels&#39;, &#39;trans&#39;]
   [(&#39;poses&#39;, (235, 156)), (&#39;gender&#39;, ()), (&#39;mocap_framerate&#39;, ()), (&#39;betas&#39;, (16,)), (&#39;marker_data&#39;, (235, 67, 3)), (&#39;dmpls&#39;, (235, 8)), (&#39;marker_labels&#39;, (67,)), (&#39;trans&#39;, (235, 3))]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Viable-Indexes">Viable Indexes<a class="anchor-link" href="#Viable-Indexes"> </a></h2><p>For every <code>npz</code> file I need to pull out the viable indexes:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="viable_slice" class="doc_header"><code>viable_slice</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L175" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>viable_slice</code>(<strong><code>cdata</code></strong>, <strong><code>keep</code></strong>)</p>
</blockquote>
<p>Inspects a dictionary loaded from <code>.npz</code> numpy dumps
and creates a slice of the viable indexes.
args:</p>

<pre><code>- `cdata`: dictionary containing keys:
    ['poses', 'gender', 'mocap_framerate', 'betas',
     'marker_data', 'dmpls', 'marker_labels', 'trans']
- `keep`: ratio of the file to keep, between zero and 1.,
    drops leading and trailing ends of the arrays

</code></pre>
<p>returns:</p>

<pre><code>- viable: slice that can access frames in the arrays:
    cdata['poses'], cdata['marker_data'], cdata['dmpls'], cdata['trans']</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">):</span>
        <span class="n">npz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="s2">&quot;npz&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
        <span class="n">npz_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">npz_files</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">:</span>
        <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="n">viable_slice</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmp1dmwr08g
/tmp/tmp1dmwr08g/sample/subdir/amass_sample.npz
   slice(60, 540, None)
/tmp/tmp1dmwr08g/sample/subdir/dmpl_sample.npz
   slice(23, 211, None)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Map-Global-Index-to-File-Indexes">Map Global Index to File Indexes<a class="anchor-link" href="#Map-Global-Index-to-File-Indexes"> </a></h2><p>I need to be able to map from a global dataset index to contiguous sets of frames in each file. Options:</p>
<ol>
<li>Whether the contiguous frames can overlap in different samples</li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="walk_npz_paths" class="doc_header"><code>walk_npz_paths</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L203" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>walk_npz_paths</code>(<strong><code>npz_directory</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_viable_slices" class="doc_header"><code>read_viable_slices</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L211" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_viable_slices</code>(<strong><code>npz_paths</code></strong>, <strong><code>keep_percent</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="global_index_map" class="doc_header"><code>global_index_map</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L224" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>global_index_map</code>(<strong><code>npz_directory</code></strong>, <strong><code>overlapping</code></strong>, <strong><code>clip_length</code></strong>, <strong><code>keep</code></strong>=<em><code>0.8</code></em>, <strong><code>cache_map</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>args:</p>

<pre><code>- `npz_directory`: Directory containing `.npz` files
- `overlapping`: Whether clips can overlap
- `clip_length`:
</code></pre>
<p>returns:</p>

<pre><code>- map from global index to corresponding file and array indexes</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Testing for clip length 1 and non-overlapping clips:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_global_index_map</span><span class="p">(</span><span class="n">clip_length</span><span class="p">,</span> <span class="n">overlapping</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
        <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">global_to_array</span><span class="p">,</span> <span class="n">n_examples</span> <span class="o">=</span> <span class="n">global_index_map</span><span class="p">(</span>
            <span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="n">overlapping</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="n">clip_length</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of examples in dataset: </span><span class="si">{</span><span class="n">n_examples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev_j</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">clip_length</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_examples</span><span class="p">):</span>
            <span class="n">npz_path</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">global_to_array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="n">clip_length</span>
            <span class="k">assert</span> <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">overlapping</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prev_j</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">j</span><span class="p">)</span>
                <span class="n">prev_j</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="n">n_examples</span>


<span class="n">test_global_index_map</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmps9k3hq75
Number of examples in dataset: 668
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Testing for clip length greater than 1 and non-overlapping:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_global_index_map</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">test_global_index_map</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmp8hvalka_
Number of examples in dataset: 222
sample_data/sample.tar.bz2 extracting to /tmp/tmp3jih9nxz
Number of examples in dataset: 167
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Testing for length of clip less than 1 and overlapping:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_global_index_map</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">test_global_index_map</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmpta70cr8w
Number of examples in dataset: 664
sample_data/sample.tar.bz2 extracting to /tmp/tmp7rgo6dtq
Number of examples in dataset: 662
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Load-Data-from-.npz-Files">Load Data from <code>.npz</code> Files<a class="anchor-link" href="#Load-Data-from-.npz-Files"> </a></h2><p>I want to load the data from the <code>.npz</code> files in a standard way, so I'm going to load each entry into its own array.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_npz" class="doc_header"><code>load_npz</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L273" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_npz</code>(<strong><code>npz_path</code></strong>, <strong><code>indexes</code></strong>, <strong><code>load_poses</code></strong>=<em><code>True</code></em>, <strong><code>load_dmpls</code></strong>=<em><code>True</code></em>, <strong><code>load_trans</code></strong>=<em><code>True</code></em>, <strong><code>load_betas</code></strong>=<em><code>True</code></em>, <strong><code>load_gender</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test this works with different clip lengths and overlapping clips.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_load_npz</span><span class="p">(</span><span class="n">clip_length</span><span class="p">,</span> <span class="n">overlapping</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
        <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">global_to_array</span><span class="p">,</span> <span class="n">n_examples</span> <span class="o">=</span> <span class="n">global_index_map</span><span class="p">(</span>
            <span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="n">overlapping</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="n">clip_length</span>
        <span class="p">)</span>
        <span class="n">npz_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="o">=</span> <span class="n">global_to_array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_npz</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">indexes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">clip_length</span>
        <span class="nb">print</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>


<span class="n">test_load_npz</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">test_load_npz</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">test_load_npz</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmp2bevwk7s
[(1, 156), (1, 8), (1, 3), (1, 16), (1,)]
sample_data/sample.tar.bz2 extracting to /tmp/tmpm2j2ugk9
[(3, 156), (3, 8), (3, 3), (3, 16), (3,)]
sample_data/sample.tar.bz2 extracting to /tmp/tmp4lloez87
[(3, 156), (3, 8), (3, 3), (3, 16), (3,)]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>How long does it take to iterate over all the sample data?</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clip_length</span><span class="p">,</span> <span class="n">overlapping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span>
<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">global_to_array</span><span class="p">,</span> <span class="n">n_examples</span> <span class="o">=</span> <span class="n">global_index_map</span><span class="p">(</span>
        <span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="n">overlapping</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="n">clip_length</span>
    <span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_examples</span><span class="p">):</span>
        <span class="n">npz_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="o">=</span> <span class="n">global_to_array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">load_npz</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">indexes</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;time to iterate: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmpj5hliecp
time to iterate: 1.8302652835845947
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clip_length</span><span class="p">,</span> <span class="n">overlapping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span>
<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">dir_size</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span><span class="o">/</span><span class="mf">1e6</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">dir_size</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span>
    <span class="n">global_to_array</span><span class="p">,</span> <span class="n">n_examples</span> <span class="o">=</span> <span class="n">global_index_map</span><span class="p">(</span>
        <span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="n">overlapping</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="n">clip_length</span>
    <span class="p">)</span>
    <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="s1">&#39;cache&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Memory</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cached_load_npz</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">load_npz</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;caching...&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_examples</span><span class="p">):</span>
        <span class="n">npz_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="o">=</span> <span class="n">global_to_array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">cached_load_npz</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">indexes</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;time to cache: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading from cache...&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_examples</span><span class="p">):</span>
        <span class="n">npz_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="o">=</span> <span class="n">global_to_array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">cached_load_npz</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">indexes</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">cache_size</span> <span class="o">=</span> <span class="n">dir_size</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;time to iterate: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;stored size (data+cache)/total: (</span><span class="si">{</span><span class="n">data_size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">MB + </span><span class="si">{</span><span class="n">cache_size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">MB)/</span><span class="si">{</span><span class="n">cache_size</span><span class="o">+</span><span class="n">data_size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">MB&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmp18asdg23
caching...
time to cache: 3.4107885360717773
loading from cache...
time to iterate: 0.48926854133605957
stored size (data+cache)/total: (2.73MB + 3.75MB)/6.49MB
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Loading from npz files and caching the result to speed everything up.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="PyTorch-Dataset-Class">PyTorch Dataset Class<a class="anchor-link" href="#PyTorch-Dataset-Class"> </a></h1><p>Creating a map-style PyTorch Dataset Class that uses these functions to load the data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AMASS" class="doc_header"><code>class</code> <code>AMASS</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L300" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AMASS</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>Dataset</code></p>
</blockquote>
<p>An abstract class representing a :class:<code>Dataset</code>.</p>
<p>All datasets that represent a map from keys to data samples should subclass
it. All subclasses should overwrite :meth:<code>__getitem__</code>, supporting fetching a
data sample for a given key. Subclasses could also optionally overwrite
:meth:<code>__len__</code>, which is expected to return the size of the dataset by many
:class:<code>~torch.utils.data.Sampler</code> implementations and the default options
of :class:<code>~torch.utils.data.DataLoader</code>.</p>
<p>.. note::
  :class:<code>~torch.utils.data.DataLoader</code> by default constructs a index
  sampler that yields integral indices.  To make it work with a map-style
  dataset with non-integral indices/keys, a custom sampler must be provided.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test I can load some data with this Dataset:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">amass</span> <span class="o">=</span> <span class="n">AMASS</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">amass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmpw_r2sl6k
poses torch.Size([1, 156])
dmpls torch.Size([1, 8])
trans torch.Size([1, 3])
betas torch.Size([1, 16])
gender torch.Size([1])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test it works in a DataLoader to make batches:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">amass</span> <span class="o">=</span> <span class="n">AMASS</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">)</span>
    <span class="n">amasstrain</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">amass</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">amasstrain</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmptugy2bd9
poses torch.Size([4, 1, 156])
dmpls torch.Size([4, 1, 8])
trans torch.Size([4, 1, 3])
betas torch.Size([4, 1, 16])
gender torch.Size([4, 1])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Caching">Caching<a class="anchor-link" href="#Caching"> </a></h1><p>Initially when I tried to load from AMASS using just a single worker (more than one worker accessing the <code>npz</code> files directly would lock up), the estimate of runtime just to iterate over the dataset was going to 160 hours. That's not practical, so I decided to use <code>joblib.Memory</code> to cache loading of the <code>npz</code> files.</p>
<p>This also involves caching the dictionary of <code>viable_slices</code> above.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">cache_amass</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Cache the data using joblib.Memory&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;amassdir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory where AMASS has been unpacked&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--verify&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Verify the output by calculating a checksum, &quot;</span>
        <span class="s2">&quot;ensures that each tar file will only be unpacked once.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--num-workers&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of Dataloader workers to run the caching with&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--bytes-limit&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Limit of bytes to store on disk (this means some data will not be cached)&quot;</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tardir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verify</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

