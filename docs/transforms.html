---

title: Transforms


keywords: fastai
sidebar: home_sidebar

summary: "Utilities to transform between a few of the many rotational formalisms."
description: "Utilities to transform between a few of the many rotational formalisms."
nb_path: "03_transforms.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03_transforms.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">llamass.core</span> <span class="kn">import</span> <span class="n">unpack_body_models</span><span class="p">,</span> <span class="n">AMASS</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Copied-Code">Copied Code<a class="anchor-link" href="#Copied-Code"> </a></h1><p>This code is copied <a href="https://github.com/nghorbani/human_body_prior/blob/0278cb45180992e4d39ba1a11601f5ecc53ee148/src/human_body_prior/tools/tgm_conversion.py">from torchgeometry in <code>nghorbani/human_body_prior</code></a>. Copying it into this library to run tests with it.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="rotation_matrix_to_angle_axis" class="doc_header"><code>rotation_matrix_to_angle_axis</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/transforms.py#L13" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rotation_matrix_to_angle_axis</code>(<strong><code>rotation_matrix</code></strong>)</p>
</blockquote>
<p>Convert 3x4 rotation matrix to Rodrigues vector
Args:
    rotation_matrix (Tensor): rotation matrix.
Returns:
    Tensor: Rodrigues vector transformation.
Shape:</p>

<pre><code>- Input: :math:`(N, 3, 4)`
- Output: :math:`(N, 3)`
</code></pre>
<p>Example:</p>

<pre><code>&gt;&gt;&gt; input = torch.rand(2, 3, 4)  # Nx4x4
&gt;&gt;&gt; output = tgm.rotation_matrix_to_angle_axis(input)  # Nx3</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="rotation_matrix_to_quaternion" class="doc_header"><code>rotation_matrix_to_quaternion</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/transforms.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rotation_matrix_to_quaternion</code>(<strong><code>rotation_matrix</code></strong>, <strong><code>eps</code></strong>=<em><code>1e-06</code></em>)</p>
</blockquote>
<p>Convert 3x4 rotation matrix to 4d quaternion vector
This algorithm is based on algorithm described in
<a href="https://github.com/KieranWynn/pyquaternion/blob/master/pyquaternion/quaternion.py#L201">https://github.com/KieranWynn/pyquaternion/blob/master/pyquaternion/quaternion.py#L201</a>
Args:
    rotation_matrix (Tensor): the rotation matrix to convert.
Return:
    Tensor: the rotation in quaternion
Shape:</p>

<pre><code>- Input: :math:`(N, 3, 4)`
- Output: :math:`(N, 4)`
</code></pre>
<p>Example:</p>

<pre><code>&gt;&gt;&gt; input = torch.rand(4, 3, 4)  # Nx3x4
&gt;&gt;&gt; output = tgm.rotation_matrix_to_quaternion(input)  # Nx4</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="quaternion_to_angle_axis" class="doc_header"><code>quaternion_to_angle_axis</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/transforms.py#L104" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>quaternion_to_angle_axis</code>(<strong><code>quaternion</code></strong>)</p>
</blockquote>
<p>Convert quaternion vector to angle axis of rotation.
Adapted from ceres C++ library: ceres-solver/include/ceres/rotation.h
Args:
    quaternion (torch.Tensor): tensor with quaternions.
Return:
    torch.Tensor: tensor with angle axis of rotation.
Shape:</p>

<pre><code>- Input: :math:`(*, 4)` where `*` means, any number of dimensions
- Output: :math:`(*, 3)`
</code></pre>
<p>Example:</p>

<pre><code>&gt;&gt;&gt; quaternion = torch.rand(2, 4)  # Nx4
&gt;&gt;&gt; angle_axis = tgm.quaternion_to_angle_axis(quaternion)  # Nx3</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="angle_axis_to_rotation_matrix" class="doc_header"><code>angle_axis_to_rotation_matrix</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/transforms.py#L148" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>angle_axis_to_rotation_matrix</code>(<strong><code>angle_axis</code></strong>)</p>
</blockquote>
<p>Convert 3d vector of axis-angle rotation to 4x4 rotation matrix
Args:
    angle_axis (Tensor): tensor of 3d vector of axis-angle rotations.
Returns:
    Tensor: tensor of 4x4 rotation matrices.
Shape:</p>

<pre><code>- Input: :math:`(N, 3)`
- Output: :math:`(N, 4, 4)`
</code></pre>
<p>Example:</p>

<pre><code>&gt;&gt;&gt; input = torch.rand(1, 3)  # Nx3
&gt;&gt;&gt; output = tgm.angle_axis_to_rotation_matrix(input)  # Nx4x4</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">rotation_matrix_to_angle_axis</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert 3x4 rotation matrix to Rodrigues vector</span>
<span class="sd">    Args:</span>
<span class="sd">        rotation_matrix (Tensor): rotation matrix.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Rodrigues vector transformation.</span>
<span class="sd">    Shape:</span>
<span class="sd">        - Input: :math:`(N, 3, 4)`</span>
<span class="sd">        - Output: :math:`(N, 3)`</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; input = torch.rand(2, 3, 4)  # Nx4x4</span>
<span class="sd">        &gt;&gt;&gt; output = tgm.rotation_matrix_to_angle_axis(input)  # Nx3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># todo add check that matrix is a valid rotation matrix</span>
    <span class="n">quaternion</span> <span class="o">=</span> <span class="n">rotation_matrix_to_quaternion</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quaternion_to_angle_axis</span><span class="p">(</span><span class="n">quaternion</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rotation_matrix_to_quaternion</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert 3x4 rotation matrix to 4d quaternion vector</span>
<span class="sd">    This algorithm is based on algorithm described in</span>
<span class="sd">    https://github.com/KieranWynn/pyquaternion/blob/master/pyquaternion/quaternion.py#L201</span>
<span class="sd">    Args:</span>
<span class="sd">        rotation_matrix (Tensor): the rotation matrix to convert.</span>
<span class="sd">    Return:</span>
<span class="sd">        Tensor: the rotation in quaternion</span>
<span class="sd">    Shape:</span>
<span class="sd">        - Input: :math:`(N, 3, 4)`</span>
<span class="sd">        - Output: :math:`(N, 4)`</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; input = torch.rand(4, 3, 4)  # Nx3x4</span>
<span class="sd">        &gt;&gt;&gt; output = tgm.rotation_matrix_to_quaternion(input)  # Nx4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input type is not a torch.Tensor. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Input size must be a three dimensional tensor. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Input size must be a N x 3 x 4  tensor. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">rmat_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">mask_d2</span> <span class="o">=</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">eps</span>

    <span class="n">mask_d0_d1</span> <span class="o">=</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">mask_d0_nd1</span> <span class="o">=</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">q0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                      <span class="n">t0</span><span class="p">,</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                      <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">t0_rep</span> <span class="o">=</span> <span class="n">t0</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                      <span class="n">t1</span><span class="p">,</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">t1_rep</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">q2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                      <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">t2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">t2_rep</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>

    <span class="n">t3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">q3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">t3</span><span class="p">,</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                      <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rmat_t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">t3_rep</span> <span class="o">=</span> <span class="n">t3</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>

    <span class="n">mask_c0</span> <span class="o">=</span> <span class="n">mask_d2</span> <span class="o">*</span> <span class="n">mask_d0_d1</span>
    <span class="n">mask_c1</span> <span class="o">=</span> <span class="n">mask_d2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask_d0_d1</span><span class="p">)</span>
    <span class="n">mask_c2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask_d2</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_d0_nd1</span>
    <span class="n">mask_c3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask_d2</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask_d0_nd1</span><span class="p">)</span>
    <span class="n">mask_c0</span> <span class="o">=</span> <span class="n">mask_c0</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">q0</span><span class="p">)</span>
    <span class="n">mask_c1</span> <span class="o">=</span> <span class="n">mask_c1</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    <span class="n">mask_c2</span> <span class="o">=</span> <span class="n">mask_c2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span>
    <span class="n">mask_c3</span> <span class="o">=</span> <span class="n">mask_c3</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">q0</span> <span class="o">*</span> <span class="n">mask_c0</span> <span class="o">+</span> <span class="n">q1</span> <span class="o">*</span> <span class="n">mask_c1</span> <span class="o">+</span> <span class="n">q2</span> <span class="o">*</span> <span class="n">mask_c2</span> <span class="o">+</span> <span class="n">q3</span> <span class="o">*</span> <span class="n">mask_c3</span>
    <span class="n">q</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t0_rep</span> <span class="o">*</span> <span class="n">mask_c0</span> <span class="o">+</span> <span class="n">t1_rep</span> <span class="o">*</span> <span class="n">mask_c1</span> <span class="o">+</span>  <span class="c1"># noqa</span>
                    <span class="n">t2_rep</span> <span class="o">*</span> <span class="n">mask_c2</span> <span class="o">+</span> <span class="n">t3_rep</span> <span class="o">*</span> <span class="n">mask_c3</span><span class="p">)</span>  <span class="c1"># noqa</span>
    <span class="n">q</span> <span class="o">*=</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">q</span>

<span class="k">def</span> <span class="nf">quaternion_to_angle_axis</span><span class="p">(</span><span class="n">quaternion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert quaternion vector to angle axis of rotation.</span>
<span class="sd">    Adapted from ceres C++ library: ceres-solver/include/ceres/rotation.h</span>
<span class="sd">    Args:</span>
<span class="sd">        quaternion (torch.Tensor): tensor with quaternions.</span>
<span class="sd">    Return:</span>
<span class="sd">        torch.Tensor: tensor with angle axis of rotation.</span>
<span class="sd">    Shape:</span>
<span class="sd">        - Input: :math:`(*, 4)` where `*` means, any number of dimensions</span>
<span class="sd">        - Output: :math:`(*, 3)`</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; quaternion = torch.rand(2, 4)  # Nx4</span>
<span class="sd">        &gt;&gt;&gt; angle_axis = tgm.quaternion_to_angle_axis(quaternion)  # Nx3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">quaternion</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input type is not a torch.Tensor. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">quaternion</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">quaternion</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input must be a tensor of shape Nx4 or 4. Got </span><span class="si">{}</span><span class="s2">&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quaternion</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="c1"># unpack input and compute conversion</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">quaternion</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">q2</span> <span class="o">=</span> <span class="n">quaternion</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">q3</span> <span class="o">=</span> <span class="n">quaternion</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">sin_squared_theta</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">*</span> <span class="n">q1</span> <span class="o">+</span> <span class="n">q2</span> <span class="o">*</span> <span class="n">q2</span> <span class="o">+</span> <span class="n">q3</span> <span class="o">*</span> <span class="n">q3</span>

    <span class="n">sin_theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sin_squared_theta</span><span class="p">)</span>
    <span class="n">cos_theta</span> <span class="o">=</span> <span class="n">quaternion</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">two_theta</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">cos_theta</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">sin_theta</span><span class="p">,</span> <span class="o">-</span><span class="n">cos_theta</span><span class="p">),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">sin_theta</span><span class="p">,</span> <span class="n">cos_theta</span><span class="p">))</span>

    <span class="n">k_pos</span> <span class="o">=</span> <span class="n">two_theta</span> <span class="o">/</span> <span class="n">sin_theta</span>
    <span class="n">k_neg</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sin_theta</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sin_squared_theta</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">k_pos</span><span class="p">,</span> <span class="n">k_neg</span><span class="p">)</span>

    <span class="n">angle_axis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">quaternion</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">angle_axis</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">q1</span> <span class="o">*</span> <span class="n">k</span>
    <span class="n">angle_axis</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">q2</span> <span class="o">*</span> <span class="n">k</span>
    <span class="n">angle_axis</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">q3</span> <span class="o">*</span> <span class="n">k</span>
    <span class="k">return</span> <span class="n">angle_axis</span>

<span class="k">def</span> <span class="nf">angle_axis_to_rotation_matrix</span><span class="p">(</span><span class="n">angle_axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert 3d vector of axis-angle rotation to 4x4 rotation matrix</span>
<span class="sd">    Args:</span>
<span class="sd">        angle_axis (Tensor): tensor of 3d vector of axis-angle rotations.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Tensor: tensor of 4x4 rotation matrices.</span>
<span class="sd">    Shape:</span>
<span class="sd">        - Input: :math:`(N, 3)`</span>
<span class="sd">        - Output: :math:`(N, 4, 4)`</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; input = torch.rand(1, 3)  # Nx3</span>
<span class="sd">        &gt;&gt;&gt; output = tgm.angle_axis_to_rotation_matrix(input)  # Nx4x4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_compute_rotation_matrix</span><span class="p">(</span><span class="n">angle_axis</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="c1"># We want to be careful to only evaluate the square root if the</span>
        <span class="c1"># norm of the angle_axis vector is greater than zero. Otherwise</span>
        <span class="c1"># we get a division by zero.</span>
        <span class="n">k_one</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span>
        <span class="n">wxyz</span> <span class="o">=</span> <span class="n">angle_axis</span> <span class="o">/</span> <span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
        <span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">wxyz</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cos_theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">sin_theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

        <span class="n">r00</span> <span class="o">=</span> <span class="n">cos_theta</span> <span class="o">+</span> <span class="n">wx</span> <span class="o">*</span> <span class="n">wx</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_one</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span>
        <span class="n">r10</span> <span class="o">=</span> <span class="n">wz</span> <span class="o">*</span> <span class="n">sin_theta</span> <span class="o">+</span> <span class="n">wx</span> <span class="o">*</span> <span class="n">wy</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_one</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span>
        <span class="n">r20</span> <span class="o">=</span> <span class="o">-</span><span class="n">wy</span> <span class="o">*</span> <span class="n">sin_theta</span> <span class="o">+</span> <span class="n">wx</span> <span class="o">*</span> <span class="n">wz</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_one</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span>
        <span class="n">r01</span> <span class="o">=</span> <span class="n">wx</span> <span class="o">*</span> <span class="n">wy</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_one</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">wz</span> <span class="o">*</span> <span class="n">sin_theta</span>
        <span class="n">r11</span> <span class="o">=</span> <span class="n">cos_theta</span> <span class="o">+</span> <span class="n">wy</span> <span class="o">*</span> <span class="n">wy</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_one</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span>
        <span class="n">r21</span> <span class="o">=</span> <span class="n">wx</span> <span class="o">*</span> <span class="n">sin_theta</span> <span class="o">+</span> <span class="n">wy</span> <span class="o">*</span> <span class="n">wz</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_one</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span>
        <span class="n">r02</span> <span class="o">=</span> <span class="n">wy</span> <span class="o">*</span> <span class="n">sin_theta</span> <span class="o">+</span> <span class="n">wx</span> <span class="o">*</span> <span class="n">wz</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_one</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span>
        <span class="n">r12</span> <span class="o">=</span> <span class="o">-</span><span class="n">wx</span> <span class="o">*</span> <span class="n">sin_theta</span> <span class="o">+</span> <span class="n">wy</span> <span class="o">*</span> <span class="n">wz</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_one</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span>
        <span class="n">r22</span> <span class="o">=</span> <span class="n">cos_theta</span> <span class="o">+</span> <span class="n">wz</span> <span class="o">*</span> <span class="n">wz</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_one</span> <span class="o">-</span> <span class="n">cos_theta</span><span class="p">)</span>
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">r00</span><span class="p">,</span> <span class="n">r01</span><span class="p">,</span> <span class="n">r02</span><span class="p">,</span> <span class="n">r10</span><span class="p">,</span> <span class="n">r11</span><span class="p">,</span> <span class="n">r12</span><span class="p">,</span> <span class="n">r20</span><span class="p">,</span> <span class="n">r21</span><span class="p">,</span> <span class="n">r22</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_rotation_matrix_taylor</span><span class="p">(</span><span class="n">angle_axis</span><span class="p">):</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">angle_axis</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">k_one</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span>
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">k_one</span><span class="p">,</span> <span class="o">-</span><span class="n">rz</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">,</span> <span class="n">k_one</span><span class="p">,</span> <span class="o">-</span><span class="n">rx</span><span class="p">,</span> <span class="o">-</span><span class="n">ry</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">k_one</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># stolen from ceres/rotation.h</span>

    <span class="n">_angle_axis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">angle_axis</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">_angle_axis</span><span class="p">,</span> <span class="n">_angle_axis</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">theta2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># compute rotation matrices</span>
    <span class="n">rotation_matrix_normal</span> <span class="o">=</span> <span class="n">_compute_rotation_matrix</span><span class="p">(</span><span class="n">angle_axis</span><span class="p">,</span> <span class="n">theta2</span><span class="p">)</span>
    <span class="n">rotation_matrix_taylor</span> <span class="o">=</span> <span class="n">_compute_rotation_matrix_taylor</span><span class="p">(</span><span class="n">angle_axis</span><span class="p">)</span>

    <span class="c1"># create mask to handle both cases</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta2</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">theta2</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">mask_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span>
    <span class="n">mask_neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span>  <span class="c1"># noqa</span>

    <span class="c1"># create output pose matrix</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">angle_axis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">angle_axis</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">angle_axis</span><span class="p">)</span>
    <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># fill output matrix with masked values</span>
    <span class="n">rotation_matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">mask_pos</span> <span class="o">*</span> <span class="n">rotation_matrix_normal</span> <span class="o">+</span> <span class="n">mask_neg</span> <span class="o">*</span> <span class="n">rotation_matrix_taylor</span>
    <span class="k">return</span> <span class="n">rotation_matrix</span>  <span class="c1"># Nx4x4</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># this cell tests that the above copied code is consistent with the code in the original library</span>
<span class="kn">import</span> <span class="nn">human_body_prior.tools.rotation_tools</span> <span class="k">as</span> <span class="nn">hbp_rot</span>

<span class="k">def</span> <span class="nf">matrot2aa</span><span class="p">(</span><span class="n">pose_matrot</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    :param pose_matrot: Nx3x3</span>
<span class="sd">    :return: Nx3</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">pose_matrot</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">homogen_matrot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pose_matrot</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">pose</span> <span class="o">=</span> <span class="n">rotation_matrix_to_angle_axis</span><span class="p">(</span><span class="n">homogen_matrot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pose</span>

<span class="k">def</span> <span class="nf">aa2matrot</span><span class="p">(</span><span class="n">pose</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    :param Nx3</span>
<span class="sd">    :return: pose_matrot: Nx3x3</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">num_joints</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span>
    <span class="n">pose_body_matrot</span> <span class="o">=</span> <span class="n">angle_axis_to_rotation_matrix</span><span class="p">(</span><span class="n">pose</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pose_body_matrot</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">amass</span> <span class="o">=</span> <span class="n">AMASS</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">)</span>
    <span class="n">poses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">amass</span><span class="p">:</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;poses&#39;</span><span class="p">][:,</span><span class="mi">3</span><span class="p">:</span><span class="mi">66</span><span class="p">]</span>
        <span class="n">poses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>
    <span class="n">poses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">poses</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">aa2matrot</span><span class="p">(</span><span class="n">poses</span><span class="p">)</span>
    <span class="n">_m</span> <span class="o">=</span> <span class="n">hbp_rot</span><span class="o">.</span><span class="n">aa2matrot</span><span class="p">(</span><span class="n">poses</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">_m</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-4</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Rotation-Class">Rotation Class<a class="anchor-link" href="#Rotation-Class"> </a></h1><blockquote><p>A <code>scipy.spatial.transform</code>-like interface to transform Tensors.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Rotation" class="doc_header"><code>class</code> <code>Rotation</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/transforms.py#L218" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Rotation</code>(<strong><code>tensor</code></strong>, <strong><code>shape</code></strong>, <strong><code>formalism</code></strong>)</p>
</blockquote>
<p>Class to give a scipy.spatial.transform-like interface
for converting between rotational formalisms in PyTorch.
Acts on trailing axes and maintains leading tensor shape.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Rotation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to give a scipy.spatial.transform-like interface</span>
<span class="sd">    for converting between rotational formalisms in PyTorch.</span>
<span class="sd">    Acts on trailing axes and maintains leading tensor shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">formalism</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formalism</span> <span class="o">=</span> <span class="n">formalism</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_rotvec</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Rotation</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="s1">&#39;rotvec&#39;</span><span class="p">)</span>
        
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Rotation</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="s1">&#39;matrix&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">as_rotvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formalism</span> <span class="o">!=</span> <span class="s1">&#39;matrix&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">rotvec</span> <span class="o">=</span> <span class="n">rotation_matrix_to_angle_axis</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">rotvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">as_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formalism</span> <span class="o">!=</span> <span class="s1">&#39;rotvec&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">matrot</span> <span class="o">=</span> <span class="n">angle_axis_to_rotation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">matrot</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">from_euler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">from_quat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">from_mrp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">as_euler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Degrees as output not supported.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formalism</span> <span class="o">==</span> <span class="s1">&#39;rotvec&#39;</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">formalism</span> <span class="o">!=</span> <span class="s1">&#39;matrix&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># initialize to zeros</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_samples</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_samples</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">e3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_samples</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># find indices where we need to treat special cases</span>
        <span class="n">is_one</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">is_minus_one</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">is_special</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">is_one</span><span class="p">,</span> <span class="n">is_minus_one</span><span class="p">)</span>
        
        <span class="n">e1</span><span class="p">[</span><span class="n">is_special</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">is_special</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">rs</span><span class="p">[</span><span class="n">is_special</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">e2</span><span class="p">[</span><span class="n">is_minus_one</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">e2</span><span class="p">[</span><span class="n">is_one</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        
        <span class="c1"># normal cases</span>
        <span class="n">is_normal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">is_one</span><span class="p">,</span> <span class="n">is_minus_one</span><span class="p">))</span>
        <span class="c1"># clip inputs to arcsin</span>
        <span class="n">in_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">is_normal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">e2</span><span class="p">[</span><span class="n">is_normal</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">in_</span><span class="p">)</span>
        <span class="n">e2_cos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="n">is_normal</span><span class="p">])</span>
        <span class="n">e1</span><span class="p">[</span><span class="n">is_normal</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">is_normal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">e2_cos</span><span class="p">,</span>
                                    <span class="n">rs</span><span class="p">[</span><span class="n">is_normal</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">e2_cos</span><span class="p">)</span>
        <span class="n">e3</span><span class="p">[</span><span class="n">is_normal</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">is_normal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">e2_cos</span><span class="p">,</span>
                                    <span class="n">rs</span><span class="p">[</span><span class="n">is_normal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">e2_cos</span><span class="p">)</span>

        <span class="n">eul</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#eul = np.reshape(eul, np.concatenate([orig_shape, eul.shape[1:]]))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">eul</span> <span class="o">=</span> <span class="n">eul</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eul</span>
    <span class="k">def</span> <span class="nf">as_quat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">as_mrp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following cell tests that the baked in <code>aa2matrot</code> function computes the same rotation matrices as scipy. It also confirms that the data is definitely encoded as rotation vectors.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MIT License</span>

<span class="sd">Copyright (c) 2016 Julieta Martinez, Javier Romero</span>

<span class="sd">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="sd">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="sd">in the Software without restriction, including without limitation the rights</span>
<span class="sd">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="sd">copies of the Software, and to permit persons to whom the Software is</span>
<span class="sd">furnished to do so, subject to the following conditions:</span>

<span class="sd">The above copyright notice and this permission notice shall be included in all</span>
<span class="sd">copies or substantial portions of the Software.</span>

<span class="sd">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="sd">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="sd">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="sd">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="sd">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="sd">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="sd">SOFTWARE.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">rotmat2euler</span><span class="p">(</span> <span class="n">R</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a rotation matrix to Euler angles</span>
<span class="sd">    Matlab port to python for evaluation purposes</span>
<span class="sd">    https://github.com/asheshjain399/RNNexp/blob/srnn/structural_rnn/CRFProblems/H3.6m/mhmublv/Motion/RotMat2Euler.m#L1</span>
<span class="sd">    Args</span>
<span class="sd">    R: a 3x3 rotation matrix</span>
<span class="sd">    Returns</span>
<span class="sd">    eul: a 3x1 Euler angle representation of R</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># special case</span>
        <span class="n">E3</span>   <span class="o">=</span> <span class="mi">0</span> <span class="c1"># set arbitrarily</span>
        <span class="n">dlta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>

        <span class="k">if</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">E2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
            <span class="n">E1</span> <span class="o">=</span> <span class="n">E3</span> <span class="o">+</span> <span class="n">dlta</span><span class="p">;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">E2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
            <span class="n">E1</span> <span class="o">=</span> <span class="o">-</span><span class="n">E3</span> <span class="o">+</span> <span class="n">dlta</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">E2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">E1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span> <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E2</span><span class="p">),</span> <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E2</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">E3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E2</span><span class="p">),</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E2</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">eul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">E1</span><span class="p">,</span> <span class="n">E2</span><span class="p">,</span> <span class="n">E3</span><span class="p">]);</span>
    <span class="k">return</span> <span class="n">eul</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">amass</span> <span class="o">=</span> <span class="n">AMASS</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">)</span>
    <span class="n">poses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">amass</span><span class="p">:</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;poses&#39;</span><span class="p">][:,</span><span class="mi">3</span><span class="p">:</span><span class="mi">66</span><span class="p">]</span>
        <span class="n">poses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>
    <span class="n">poses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">poses</span><span class="p">)</span>
    
    <span class="c1"># test rotvec -&gt; matrix</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">poses</span><span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
    <span class="c1"># check if this match scipy</span>
    <span class="n">matrots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rotvec</span> <span class="ow">in</span> <span class="n">poses</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">rotvec</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">matrots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">())</span>
    <span class="n">matrots</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">matrots</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">matrots</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-5</span>
    
    <span class="c1"># test matrix -&gt; rotvec</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">as_rotvec</span><span class="p">()</span>
    <span class="n">rotvecs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">rotvecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">as_rotvec</span><span class="p">())</span>
    <span class="n">rotvecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">rotvecs</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rotvecs</span> <span class="o">-</span> <span class="n">aa</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-5</span>
    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">poses</span> <span class="o">-</span> <span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-5</span>
    
    <span class="c1"># test rotvec -&gt; matrix -&gt; euler</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">poses</span><span class="p">)</span><span class="o">.</span><span class="n">as_euler</span><span class="p">()</span>
    <span class="c1"># iterate over all possible euler angle conventions</span>
    <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">permutations</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">),</span> <span class="n">permutations</span><span class="p">(</span><span class="s1">&#39;XYZ&#39;</span><span class="p">)):</span>
        <span class="n">euler_angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rotvec</span> <span class="ow">in</span> <span class="n">poses</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">rotvec</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">euler_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">as_euler</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">euler_angles</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">euler_angles</span><span class="p">))</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">euler_angles</span> <span class="o">-</span> <span class="n">e</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1">#print(seq, *[x.item() for x in [err, e.min(), e.max(), euler_angles.min(), euler_angles.max()]])</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Euler angle computation does not match any convention.&quot;</span><span class="p">)</span>
    <span class="n">euler_angles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rotmat</span> <span class="ow">in</span> <span class="n">matrots</span><span class="p">:</span>
        <span class="n">euler_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotmat2euler</span><span class="p">(</span><span class="n">rotmat</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
    <span class="n">euler_angles</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">euler_angles</span><span class="p">))</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">euler_angles</span> <span class="o">-</span> <span class="n">e</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mf">1e-5</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/nobackup/gngdb/envs/amass/lib/python3.7/site-packages/ipykernel_launcher.py:44: UserWarning: Euler angle computation does not match any convention.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="n">matrots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">rotmat2euler</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">permutations</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">),</span> <span class="n">permutations</span><span class="p">(</span><span class="s1">&#39;XYZ&#39;</span><span class="p">)):</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
    <span class="n">_e</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">as_euler</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">e</span><span class="o">-</span><span class="n">_e</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>xyz [ 1.54809437  0.31419901 -0.26214211]
xzy [1.52761688 0.01639201 0.03872136]
yxz [ 0.91142335  0.98763906 -0.15936584]
yzx [0.97618798 0.14463208 0.71229793]
zxy [0.50030164 0.95476593 0.22065227]
zyx [0.69825729 0.42061958 0.69825729]
XYZ [ 1.53083387  0.42061958 -0.13431928]
XZY [1.5448745  0.14463208 0.1436114 ]
YXZ [ 1.05322884  0.95476593 -0.33227493]
YZX [0.87129794 0.01639201 0.6950403 ]
ZXY [0.67321073 0.98763906 0.07884678]
ZYX [0.57043446 0.31419901 0.7155178 ]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Scipy-Transforms">Scipy Transforms<a class="anchor-link" href="#Scipy-Transforms"> </a></h1><blockquote><p>Transforms to use during data loading on numpy arrays using <code>scipy.spatial.transforms</code>.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="scipy_aa_to_euler" class="doc_header"><code>scipy_aa_to_euler</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/transforms.py#L302" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>scipy_aa_to_euler</code>(<strong><code>x</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="scipy_euler_to_aa" class="doc_header"><code>scipy_euler_to_aa</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/transforms.py#L310" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>scipy_euler_to_aa</code>(<strong><code>x</code></strong>, <strong><code>zero_center</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">scipy_aa_to_euler</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">aa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">euler</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">as_euler</span><span class="p">(</span><span class="s1">&#39;zyx&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">euler</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">scipy_euler_to_aa</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">zero_center</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">zero_center</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">euler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">euler</span><span class="p">)</span><span class="o">.</span><span class="n">as_rotvec</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">aa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

