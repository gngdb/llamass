---

title: llamass


keywords: fastai
sidebar: home_sidebar

summary: "A Light Loader for the [AMASS dataset][amass] to make downloading and training on it easier."
description: "A Light Loader for the [AMASS dataset][amass] to make downloading and training on it easier."
nb_path: "index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Badges">Badges<a class="anchor-link" href="#Badges"> </a></h2><p><a href="https://badge.fury.io/py/llamass"><img src="https://badge.fury.io/py/llamass.svg" alt="PyPI version"></a></p>
<p><img src="https://github.com/gngdb/llamass/workflows/CI/badge.svg" alt="example workflow"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="License-Agreement">License Agreement<a class="anchor-link" href="#License-Agreement"> </a></h3><p>Before using the AMASS dataset I'm expected to sign up to the license agreeement <a href="https://amass.is.tue.mpg.de/index.html">here</a>. This package doesn't require any other code from MPI but visualization of pose data does, see below.</p>
<h3 id="Install-with-pip">Install with pip<a class="anchor-link" href="#Install-with-pip"> </a></h3><p>Requirements are handled by pip during the install but in a new environment I would install <a href="https://pytorch.org/get-started/locally/">pytorch</a>
first to configure cuda as required for the system.</p>
<p><code>pip install llamass</code></p>
<h3 id="For-Visualization">For Visualization<a class="anchor-link" href="#For-Visualization"> </a></h3><p>To visualise this data <a href="https://is.mpg.de/">MPI</a> packages are required and they ask you to sign up to abide by their license:</p>
<ul>
<li><a href="https://github.com/nghorbani/human_body_prior">Human Body Prior</a>, licensed under the <a href="https://smpl-x.is.tue.mpg.de/">SMPL-X project</a></li>
<li><a href="https://github.com/nghorbani/body_visualizer">Body Visualizer</a>, licensed under the <a href="https://smpl-x.is.tue.mpg.de/">SMPL-X project</a></li>
</ul>
<p>To install on e.g. colab the following code snippet should work (I've fixed versions because these are the versions I've tested):</p>

<pre><code>import os
os.environ["PYOPENGL_PLATFORM"] = "egl"
!pip install pyrender
!pip install mediapy
!pip install human_body_prior@git+https://github.com/nghorbani/human_body_prior@7f0a4b3#egg=human_body_prior
!pip install body_visualizer@git+https://github.com/nghorbani/body_visualizer@fe4e5e8#egg=body_visualizer</code></pre>
<p>This relies on EGL being installed, which it is on colab but may require some configuration</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Downloading-the-data">Downloading the data<a class="anchor-link" href="#Downloading-the-data"> </a></h3><p>The <a href="https://amass.is.tue.mpg.de/index.html">AMASS website</a> provides links to download the various parts of the AMASS dataset. Each is provided as a <code>.tar.bz2</code> and I had to download them from the website by hand. Save all of these in a folder somehwere.</p>
<h3 id="Unpacking-the-data">Unpacking the data<a class="anchor-link" href="#Unpacking-the-data"> </a></h3><p>After installing <code>llamass</code> a console script is provided to unpack the <code>tar.bz2</code> files downloaded from the <a href="https://amass.is.tue.mpg.de/index.html">AMASS</a> website:</p>

<pre><code>fast_amass_unpack -n 4 --verify &lt;dir with .tar.bz2 files&gt; &lt;dir to save unpacked data&gt;</code></pre>
<p>This will unpack the data in parallel in 4 jobs and provides a progress bar. The <code>--verify</code> flag will <code>md5sum</code> the directory the files are unpacked to and check it against what I found when I unpacked it. It'll also avoid unpacking tar files that have already been unpacked by looking for saved <code>.hash</code> files in the target directory. It's slower but more reliable and recovers from incomplete unpacking.</p>
<p>Alternatively, this can be access in the library using the <code>llamass.core.unpack_body_models</code> function:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">llamass.core</span>

<span class="n">llamass</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">unpacked_directory</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/sample.tar.bz2 extracting to /tmp/tmpzua5zgez
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Download-Metadata">Download Metadata<a class="anchor-link" href="#Download-Metadata"> </a></h3><p>I've processed the files to find out how many frames are in each numpy archive unpacked when <a href="/llamass/core.html#fast_amass_unpack"><code>fast_amass_unpack</code></a> is run. By default, the first time the <a href="/llamass/core.html#AMASS"><code>AMASS</code></a> Dataset object is asked for it's <code>len</code> it will look for a file containing this information in the specified AMASS directory. If it doesn't find it, it will recompute it and that can take 5 minutes.</p>
<p>Save 5 minutes by downloading it from this repository:</p>

<pre><code>wget https://github.com/gngdb/llamass/raw/master/npz_file_lens.json.gz -P &lt;dir to save unpacked data&gt;</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Using-the-data">Using the data<a class="anchor-link" href="#Using-the-data"> </a></h3><p>Once the data is unpacked it can be loaded by a PyTorch DataLoader directly using the <code>llamass.core.AMASS</code> Dataset class.</p>
<ul>
<li><code>overlapping</code>: whether the clips of frames taken from each file should be allowed to overlap</li>
<li><code>clip_length</code>: how long should clips from each file be?</li>
<li><code>transform</code>: a transformation function apply to all fields</li>
</ul>
<p>It is an <a href="https://pytorch.org/docs/stable/data.html#iterable-style-datasets">IterableDataset</a> so it <strong>cannot be shuffled by the DataLoader</strong>. If <code>shuffle=True</code> the DataLoader will hit an error. However, the <a href="/llamass/core.html#AMASS"><code>AMASS</code></a> class itself implements shuffling and it can be enabled using <code>shuffle=True</code> at initialisation.</p>
<p>Also, in order to use more than one worker it is necessary to use the provided <a href="/llamass/core.html#worker_init_fn"><code>worker_init_fn</code></a> in the DataLoader:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="n">amass</span> <span class="o">=</span> <span class="n">llamass</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">AMASS</span><span class="p">(</span>
    <span class="n">unpacked_directory</span><span class="p">,</span>
    <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">amassloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">amass</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">worker_init_fn</span><span class="o">=</span><span class="n">llamass</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">worker_init_fn</span><span class="p">)</span>

<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">amassloader</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>poses torch.Size([4, 1, 156])
dmpls torch.Size([4, 1, 8])
trans torch.Size([4, 1, 3])
betas torch.Size([4, 1, 16])
gender torch.Size([4, 1])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="To-do">To do<a class="anchor-link" href="#To-do"> </a></h2><p>To do:</p>
<ul>
<li><del>Add step in setup above to wget the file lengths</del></li>
<li><del>Instructions on how to install the requirements for visualization</del></li>
<li>Augmentations pulled from original AMASS repo</li>
<li>Example train/test splits by unpacking different datasets to different locations</li>
<li>Update and link the colab notebook demonstrating visualization</li>
</ul>

</div>
</div>
</div>
</div>
 

